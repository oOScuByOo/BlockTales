<canvas id="game" width="500" height="500" style="border:1px solid #000000;"></canvas>

<script>

  var game = document.getElementById('game').getContext("2d");
  game.font = '30px Arial';

  var HEIGHT = 500;
  var WIDTH = 500;

  var timeWhenGameStarted = Date.now();

  var frameCount = 0;

  var score = 0;

  var player;

  Entity = function(type,id,x,y,spdX,spdY,width,height,color) {
    var self = {
      type:type,
      x:x,
      y:x,
      spdX:spdX,
      spdY:spdY,
      width:width,
      height:height,
      color:color,
    };
    self.update = function() {
      self.updatePosition();
      self.draw();
    }
    self.updatePosition = function() {
      if(self.type === 'player') {
        if(self.pressingRight)
          self.x += 10;
        if(self.pressingLeft)
          self.x -= 10;
        if(self.pressingDown)
          self.y += 10;
        if(self.pressingUp)
          self.y -= 10;

        if(self.x < self.width/2)
          self.x = self.width/2;
        if(self.x > WIDTH - self.width/2)
          self.x = WIDTH - self.width/2;
        if(self.y < self.height/2)
          self.y = self.height/2;
        if(self.y > HEIGHT - self.height/2)
          self.y = HEIGHT - self.height/2;
      }
      else {
        self.x += self.spdX;
        self.y += self.spdY;
        if(self.x < 0 || self.x > WIDTH) {
          self.spdX = -self.spdX;
        }
        if(self.y < 0 || self.y > HEIGHT) {
          self.spdY = -self.spdY;
        }
      }
    }
    self.draw = function() {
      game.save();
      game.fillStyle = self.color;
      game.fillRect(self.x-self.width/2,self.y-self.height/2,self.width,self.height);
      game.restore();
    }
    self.getDistance = function(entity2) {
      var vx = self.x - entity2.x;
      var vy = self.y - entity2.y;
      return Math.sqrt(vx*vx+vy*vy);
    }
    self.testCollision = function(entity2) {

      var rect1 = {
        x:self.x-self.width/2,
        y:self.y-self.height/2,
        width:self.width,
        height:self.height,
      }

      var rect2 = {
        x:entity2.x-entity2.width/2,
        y:entity2.y-entity2.height/2,
        width:entity2.width,
        height:entity2.height,
      }

      return testCollisionRectRect(rect1,rect2);
    }

    return self;
  }

  createPlayer = function() {
    var self = Entity('player','myID',50,40,30,5,20,20,'green');

    self.atkSpd = 1;
    self.attackCounter = 0;
    self.aimAngle = 0;
    self.hp = 10;
    self.maxHp = 10;

    self.pressingDown = false;
    self.pressingUp = false;
    self.pressingLeft = false;
    self.pressingRight = false;

    player = self;
  }

  var enemyList = {};

  var upgradeList = {};

  var bulletList = {};

  Enemy = function(id,x,y,spdX,spdY,width,height) {
    var self = Entity('ennemy',id,x,y,spdX,spdY,width,height,'red');

    self.hp = 10;
    self.aimAngle = 0;
    self.atkSpd = 1;
    self.attackCounter = 0;

    enemyList[id] = self;
  }

  randomlyGenerateEnemy = function() {

    var x = Math.random()*WIDTH;
    var y = Math.random()*HEIGHT;
    var height = 10 + Math.random()*30;
    var width = 10 + Math.random()*30;
    var id = Math.random();
    var spdX = 5 + Math.random() * 5;
    var spdY = 5 + Math.random() * 5;

    Enemy(id,x,y,spdX,spdY,width,height);

  }

  Upgrade = function(id,x,y,spdX,spdY,width,height,category,color) {
    var self = Entity('upgrade',id,x,y,spdX,spdY,width,height,color);

    self.category = category;

    upgradeList[id] = self;
  }

  randomlyGenerateUpgrade = function() {

    var x = Math.random()*WIDTH;
    var y = Math.random()*HEIGHT;
    var height = 10;
    var width = 10;
    var id = Math.random();
    var spdX = 0;
    var spdY = 0;

    if(Math.random() < 0.5) {
      var category = 'score';
      var color = 'violet';
    }
    else {
      var category = 'atkspd';
      var color = 'purple';
    }

    Upgrade(id,x,y,spdX,spdY,width,height,category,color);

  }

  Bullet = function(id,x,y,spdX,spdY,width,height) {
    var self = Entity('bullet',id,x,y,spdX,spdY,width,height,'black');

    self.timer = 0;

    bulletList[id] = self;
  }

  generateBullet = function(actor,overwriteAngle) {

    var x = actor.x;
    var y = actor.y;
    var height = 5;
    var width = 5;
    var id = Math.random();
    var angle = actor.aimAngle;
    if(overwriteAngle !== undefined) {
      angle = overwriteAngle;
    }
    var spdX = Math.cos(angle/180*Math.PI)*5;
    var spdY = Math.sin(angle/180*Math.PI)*5;

    Bullet(id,x,y,spdX,spdY,width,height);

  }

  testCollisionRectRect = function(rect1,rect2) {
    return rect1.x <= rect2.x+rect2.width
        && rect2.x <= rect1.x+rect1.width
        && rect1.y <= rect2.y+rect2.height
        && rect2.y <= rect1.y+rect1.height;
  }

  document.onmousemove = function(event) {
    var mouseX = event.clientX - document.getElementById('game').getBoundingClientRect().left;
    var mouseY = event.clientY - document.getElementById('game').getBoundingClientRect().top;

    mouseX -= player.x;
    mouseY -= player.y;

    player.aimAngle = Math.atan2(mouseY,mouseX) / Math.PI * 180;

  }

  document.onclick = function(event) {
    performAttack(player);
  }

  document.oncontextmenu = function(event) {
    performSpecialAttack(player);
    event.preventDefault();
  }

  document.onkeydown = function(event) {
    if(event.keyCode === 68) // D
      player.pressingRight = true;
    else if(event.keyCode === 83) // S
      player.pressingDown = true;
    else if(event.keyCode === 81) // Q
      player.pressingLeft = true;
    else if(event.keyCode === 90) // Z
      player.pressingUp = true;
  }

  document.onkeyup = function(event) {
    if(event.keyCode === 68) // D
      player.pressingRight = false;
    else if(event.keyCode === 83) // S
      player.pressingDown = false;
    else if(event.keyCode === 81) // Q
      player.pressingLeft = false;
    else if(event.keyCode === 90) // Z
      player.pressingUp = false;
  }

  performAttack = function(actor) {
    if(actor.attackCounter > 25) {
      actor.attackCounter = 0;
      generateBullet(actor);
    }
  }

  performSpecialAttack = function(actor) {
    if(actor.attackCounter > 50) {
      actor.attackCounter = 0;
    /* // Attaque 360°
      for(var angle = 0; angle < 360; angle++) {
        generateBullet(actor,angle);
      }
    */
      generateBullet(actor,actor.aimAngle - 5);
      generateBullet(actor,actor.aimAngle);
      generateBullet(actor,actor.aimAngle + 5);
    }
  }

  update = function() {

    game.clearRect(0,0,WIDTH,HEIGHT);

    frameCount++;

    score++;

    if(frameCount % 100 === 0)
    randomlyGenerateEnemy();

    if(frameCount % 75 === 0)
    randomlyGenerateUpgrade();

    player.attackCounter += player.atkSpd;

    for(var getBulletList in bulletList) {
      bulletList[getBulletList].update();

      var toRemove = false;
      bulletList[getBulletList].timer++;
      if(bulletList[getBulletList].timer > 75) {
        toRemove = true;
      }

      for(var getEnemyList in enemyList) {
        var isColliding = bulletList[getBulletList].testCollision(enemyList[getEnemyList]);
        if(isColliding) {
          toRemove = true;
          delete enemyList[getEnemyList];
          break;
        }
      }
      if(toRemove) {
        delete bulletList[getBulletList];
      }
    }

    for(var getUpgradeList in upgradeList) {
      upgradeList[getUpgradeList].update();

      var isColliding = player.testCollision(upgradeList[getUpgradeList]);
      if(isColliding) {
        if(upgradeList[getUpgradeList].category === 'score')
        score += 1000;
        if(upgradeList[getUpgradeList].category === 'atkspd')
        player.atkSpd += 3;
        delete upgradeList[getUpgradeList];
      }
    }

    for(var getEnemyList in enemyList) {
      enemyList[getEnemyList].update();

      var isColliding = player.testCollision(enemyList[getEnemyList]);
      if(isColliding) {
        player.hp = player.hp - 1;
      }
    }

    if(player.hp <= 0) {
      var timeSurvived = Date.now() - timeWhenGameStarted;

      alert("Vous avez perdu ! Vous avez survécu " + timeSurvived + " ms.");

      startNewGame();

    }
    player.update();
    game.fillText(player.hp + " HP",0,30);
    game.fillText('Score : ' + score,200,30);
  }

  startNewGame = function() {
    player.hp = 10;
    timeWhenGameStarted = Date.now();
    frameCount = 0;
    score = 0;
    enemyList = {};
    upgradeList = {};
    bulletList = {};
    randomlyGenerateEnemy();
    randomlyGenerateEnemy();
    randomlyGenerateEnemy();
  }

  // Enemy('E1',150,350,10,15,'E1',30,30);
  // Enemy('E2',250,350,10,-15,'E2',20,20);
  // Enemy('E3',25,120,-15,20,'E3',25,25);

  createPlayer();
  startNewGame();

  setInterval(update,40);

</script>
