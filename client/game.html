<canvas id="game" width="500" height="500" style="border:1px solid #000000;"></canvas>

<script>

  var game = document.getElementById('game').getContext("2d");
  game.font = '30px Arial';

  var HEIGHT = 500;
  var WIDTH = 500;

  var timeWhenGameStarted = Date.now();

  var frameCount = 0;

  var score = 0;

  var player = {
    x:50,
    y:40,
    spdX:30,
    spdY:5,
    name:'P',
    hp:10,
    maxHp:20,
    width:20,
    height:20,
    color:'green',
    atkSpd:1,
    attackCounter:0,
    pressingDown:false,
    pressingUp:false,
    pressingLeft:false,
    pressingRight:false,
  };

  var enemyList = {};

  var upgradeList = {};

  var bulletList = {};

  getDistanceBetweenEntity = function(entity1,entity2) {
    var vx = entity1.x - entity2.x;
    var vy = entity1.y - entity2.y;
    return Math.sqrt(vx*vx+vy*vy);
  }

  testCollisionEntity = function(entity1,entity2) {

    var rect1 = {
      x:entity1.x-entity1.width/2,
      y:entity1.y-entity1.height/2,
      width:entity1.width,
      height:entity1.height,
    }

    var rect2 = {
      x:entity2.x-entity2.width/2,
      y:entity2.y-entity2.height/2,
      width:entity2.width,
      height:entity2.height,
    }

    return testCollisionRectRect(rect1,rect2);
  }

  Enemy = function(id,x,y,spdX,spdY,width,height) {
    var enemy = {
      x:x,
      y:y,
      spdX:spdX,
      spdY:spdY,
      id:id,
      width:width,
      height:height,
      color:'red',
    };
    enemyList[id] = enemy;
  }

  randomlyGenerateEnemy = function() {

    var x = Math.random()*WIDTH;
    var y = Math.random()*HEIGHT;
    var height = 10 + Math.random()*30;
    var width = 10 + Math.random()*30;
    var id = Math.random();
    var spdX = 5 + Math.random() * 5;
    var spdY = 5 + Math.random() * 5;

    Enemy(id,x,y,spdX,spdY,width,height);

  }

  Upgrade = function(id,x,y,spdX,spdY,width,height,category,color) {
    var upgrade = {
      x:x,
      y:y,
      spdX:spdX,
      spdY:spdY,
      id:id,
      width:width,
      height:height,
      color:color,
      category:category,
    };
    upgradeList[id] = upgrade;
  }

  randomlyGenerateUpgrade = function() {

    var x = Math.random()*WIDTH;
    var y = Math.random()*HEIGHT;
    var height = 10;
    var width = 10;
    var id = Math.random();
    var spdX = 0;
    var spdY = 0;

    if(Math.random() < 0.5) {
      var category = 'score';
      var color = 'violet';
    }
    else {
      var category = 'atkspd';
      var color = 'purple';
    }

    Upgrade(id,x,y,spdX,spdY,width,height,category,color);

  }

  Bullet = function(id,x,y,spdX,spdY,width,height) {
    var bullet = {
      x:x,
      y:y,
      spdX:spdX,
      spdY:spdY,
      id:id,
      width:width,
      height:height,
      color:'black',
      timer:0,
    };
    bulletList[id] = bullet;
  }

  randomlyGenerateBullet = function() {

    var x = player.x;
    var y = player.y;
    var height = 5;
    var width = 5;
    var id = Math.random();
    var angle = Math.random()*360;
    var spdX = Math.cos(angle/180*Math.PI)*5;
    var spdY = Math.sin(angle/180*Math.PI)*5;

    Bullet(id,x,y,spdX,spdY,width,height);

  }

  updateEntity = function(value) {
    updateEntityPosition(value);
    drawEntity(value);
  }

  updateEntityPosition = function(value) {
    value.x += value.spdX;
    value.y += value.spdY;

    if(value.x < 0 || value.x > WIDTH) {
      value.spdX = -value.spdX;
    }

    if(value.y < 0 || value.y > HEIGHT) {
      value.spdY = -value.spdY;
    }
  }

  testCollisionRectRect = function(rect1,rect2) {
    return rect1.x <= rect2.x+rect2.width
        && rect2.x <= rect1.x+rect1.width
        && rect1.y <= rect2.y+rect2.height
        && rect2.y <= rect1.y+rect1.height;
  }

  drawEntity = function(value) {
    game.save();
    game.fillStyle = value.color;
    game.fillRect(value.x-value.width/2,value.y-value.height/2,value.width,value.height);
    game.restore();
  }

  document.onclick = function(mouse) {
    if(player.attackCounter > 25) {
      randomlyGenerateBullet();
      player.attackCounter = 0;
    }
  }

  document.onkeydown = function(event) {
    if(event.keyCode === 68) // D
      player.pressingRight = true;
    else if(event.keyCode === 83) // S
      player.pressingDown = true;
    else if(event.keyCode === 81) // Q
      player.pressingLeft = true;
    else if(event.keyCode === 90) // Z
      player.pressingUp = true;
  }

  document.onkeyup = function(event) {
    if(event.keyCode === 68) // D
      player.pressingRight = false;
    else if(event.keyCode === 83) // S
      player.pressingDown = false;
    else if(event.keyCode === 81) // Q
      player.pressingLeft = false;
    else if(event.keyCode === 90) // Z
      player.pressingUp = false;
  }

  updatePlayerPosition = function() {
    if(player.pressingRight)
      player.x += 10;
    if(player.pressingLeft)
      player.x -= 10;
    if(player.pressingDown)
      player.y += 10;
    if(player.pressingUp)
      player.y -= 10;

    if(player.x < player.width/2)
      player.x = player.width/2;
    if(player.x > WIDTH - player.width/2)
      player.x = WIDTH - player.width/2;
    if(player.y < player.height/2)
      player.y = player.height/2;
    if(player.y > HEIGHT - player.height/2)
      player.y = HEIGHT - player.height/2;

  }

  update = function() {

    game.clearRect(0,0,WIDTH,HEIGHT);

    frameCount++;

    score++;

    if(frameCount % 100 === 0)
    randomlyGenerateEnemy();

    if(frameCount % 75 === 0)
    randomlyGenerateUpgrade();

    player.attackCounter += player.atkSpd;

    for(var getBulletList in bulletList) {
      updateEntity(bulletList[getBulletList]);

      var toRemove = false;
      bulletList[getBulletList].timer++;
      if(bulletList[getBulletList].timer > 75) {
        toRemove = true;
      }

      for(var getEnemyList in enemyList) {
        var isColliding = testCollisionEntity(bulletList[getBulletList],enemyList[getEnemyList]);
        if(isColliding) {
          toRemove = true;
          delete enemyList[getEnemyList];
          break;
        }
      }
      if(toRemove) {
        delete bulletList[getBulletList];
      }
    }

    for(var getUpgradeList in upgradeList) {
      updateEntity(upgradeList[getUpgradeList]);

      var isColliding = testCollisionEntity(player,upgradeList[getUpgradeList]);
      if(isColliding) {
        if(upgradeList[getUpgradeList].category === 'score')
        score += 1000;
        if(upgradeList[getUpgradeList].category === 'atkspd')
        player.atkSpd += 3;
        delete upgradeList[getUpgradeList];
      }
    }

    for(var getEnemyList in enemyList) {
      updateEntity(enemyList[getEnemyList]);

      var isColliding = testCollisionEntity(player,enemyList[getEnemyList]);
      if(isColliding) {
        player.hp = player.hp - 1;
      }
    }

    if(player.hp <= 0) {
      var timeSurvived = Date.now() - timeWhenGameStarted;

      alert("Vous avez perdu ! Vous avez survÃ©cu " + timeSurvived + " ms.");

      startNewGame();

    }
    updatePlayerPosition();
    drawEntity(player);
    game.fillText(player.hp + " HP",0,30);
    game.fillText('Score : ' + score,200,30);
  }

  startNewGame = function() {
    player.hp = 10;
    timeWhenGameStarted = Date.now();
    frameCount = 0;
    score = 0;
    enemyList = {};
    upgradeList = {};
    bulletList = {};
    randomlyGenerateEnemy();
    randomlyGenerateEnemy();
    randomlyGenerateEnemy();
  }

  // Enemy('E1',150,350,10,15,'E1',30,30);
  // Enemy('E2',250,350,10,-15,'E2',20,20);
  // Enemy('E3',25,120,-15,20,'E3',25,25);

  randomlyGenerateEnemy();
  randomlyGenerateEnemy();
  randomlyGenerateEnemy();

  setInterval(update,40);

</script>
